#
# $Id: Makefile.include 241 2017-04-19 07:53:25Z wimalopaan $
#
#  scanbd - KMUX scanner button daemon
#
#  Copyright (C) 2008 - 2016  Wilhelm Meier (wilhelm.wm.meier@googlemail.com)
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
#
# Makefile.conf is generated from Makefile.conf.in by makefile from automake.
# This will set package name and version
#
# DO NOT EDIT THIS FILE
# local changes shall be made in Makefile.conf
# Values set there will override the defaults here
#
#
# TODO: add systemd config here
# TODO: add udev config here
# TODO: add hald config here
#
# Include  Makefile.conf for local settings
# ===============================================
#
my_name := $(lastword $(MAKEFILE_LIST))
echo := $(shell echo $(my_name))
my_path := $(shell dirname $(my_name))
-include $(my_path)/Makefile.conf

#
# Set package name and version
# ============================
#
PACKAGE = scanbd
PACKAGE_VERSION = 1.92


OSTYPE := $(shell uname)
PKGCFG := $(shell which pkg-config)

#
# Dbus dependencies
# =================
#
ifneq ($(findstring pkg-config, $(PKGCFG)),)
DBUS_INCLUDE := $(shell pkg-config dbus-1 --cflags)
else
DBUS_INCLUDE=
endif

#
# Set default prefix
# ===================
#
ifndef PREFIX
PREFIX := /usr/local
endif

# 
# Set own directories
# ==================
#
## ifndef DESTDIR
## SCANBD_CFG_DIR = $(PREFIX)/etc/scanbd
## else
## PREFIX = $(DESTDIR)/usr
## SCANBD_CFG_DIR = $(DESTDIR)/etc/scanbd
## endif
## SCANBUTTOND_LIB_DIR=$(SCANBD_CFG_DIR)/scanbuttond/backends
## 
## BIN_DIR = $(PREFIX)/bin

ifndef BIN_DIR
BIN_DIR := $(PREFIX)/sbin
endif 

ifndef SCANBD_CFG_DIR
SCANBD_CFG_DIR := $(PREFIX)/etc/scanbd
endif

ifndef SCANBUTTOND_LIB_DIR
SCANBUTTOND_LIB_DIR := $(PREFIX)/lib/scanbuttond
endif

# 
# Saned path
# ==========
#
ifndef SANED_PATH
SANED_PATH := $(shell PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/libexec:/usr/local/bin:/usr/local//sbin:/usr/local/libexec which saned)
endif

#
# OS dependent settings
# ======================
#
ifndef DBUS_PREFIX
ifeq ($(OSTYPE),FreeBSD)
DBUS_PREFIX := /usr/local
else
ifndef DESTDIR
DBUS_PREFIX :=
else
DBUS_PREFIX := $(DESTDIR)
endif # DESTDIR
endif # OSTYPE
endif # DBUS_PREFIX

ifndef USE_LIBUDEV
ifndef USE_HAL
ifeq ($(OSTYPE),Linux)
USE_LIBUDEV := yes
else
USE_LIBUDEV :=
endif

ifndef USE_LIBUDEV
USE_HAL := yes
endif
endif # USE_HAL
endif # USE_UDEV

#
# Use sane or scanbuttond?
# ========================
#
ifndef USE_SCANBUTTOND
USE_SANE := yes 
endif

#
# Disable debugging code?
# =======================
#
ifdef NDEBUG
CPPFLAGS += -DNDEBUG
endif

#
# CPP and LD flags
# =================
#
ifeq ($(OSTYPE),Linux)
CPPFLAGS += -I/usr/include/dbus-1.0 -I/usr/lib/dbus-1.0/include $(DBUS_INCLUDE) -DHAVE_LINUX_LIMITS_H -I../scanbuttond/include
endif

ifeq ($(OSTYPE),FreeBSD)
CPPFLAGS += -I/usr/local/include -I/usr/local/include/dbus-1.0 -I/usr/local/include/dbus-1.0/include $(DBUS_INCLUDE) -I../scanbuttond/include
LDLIBS  += -L/usr/local/lib 
endif
ifeq ($(OSTYPE),NetBSD)
CPPFLAGS += -I/usr/pkg/include -I/usr/pkg/include/dbus-1.0 -I/usr/pkg/lib/dbus-1.0/include $(DBUS_INCLUDE) -I../scanbuttond/include
LDLIBS  +=  -lconfuse -lpthread -ldbus-1
endif

ifeq ($(OSTYPE),OpenBSD)
USE_HAL=
CPPFLAGS += -I/usr/local/include -I/usr/local/include/dbus-1.0 -I/usr/local/lib/dbus-1.0/include $(DBUS_INCLUDE) -I../scanbuttond/include
LDLIBS  += -L/usr/local/lib 
endif

ifdef USE_SANE
CPPFLAGS += -DUSE_SANE -UUSE_SCANBUTTOND
LDLIBS += -lsane
else # USE_SANE
CPPFLAGS += -UUSE_SANE -DUSE_SCANBUTTOND -I./scanbuttond/include
LDFLAGS += -rdynamic
LDLIBS += -lusb
ifeq ($(OSTYPE),Linux)
LDLIBS += -ldl
endif
endif # USE_SANE

ifdef USE_HAL
CPPFLAGS += -DUSE_HAL
LDLIBS  += -lhal
endif # USE_HAL

ifdef USE_LIBUDEV
CPPFLAGS += -DUSE_LIBUDEV
LDLIBS += -ludev
endif # USE_LIBUDEV

# 
# Define common options
# ======================
#
CFLAGS   += -Wall -Wextra -std=c11 -g
LDLIBS  += -lconfuse -lpthread -ldbus-1
CPPFLAGS += -DSCANBD_CFG_DIR=\"$(SCANBD_CFG_DIR)\" -DSCANBUTTOND_LIB_DIR=\"$(SCANBUTTOND_LIB_DIR)\" \
	-DSANED_PATH=\"$(SANED_PATH)\"

# 
# SCANBD_USER
# ===========
#
ifndef SCANBD_USER

ifdef USE_LIBUDEV
SCANBD_USER := saned
else

ifeq ($(OSTYPE),OpenBSD)
SCANBD_USER := root
endif

ifeq ($(OSTYPE),FreeBSD)
SCANBD_USER := root
endif

ifeq ($(OSTYPE),NetBSD)
SCANBD_USER := root
endif

ifeq ($(OSTYPE),Linux)
SCANBD_USER := saned
endif

endif	# USE_LIBUDEV

endif	# SCANBD_USER


# 
# SCANBD_GROUP
# ============
#
ifndef SCANBD_GROUP

ifdef USE_LIBUDEV
SCANBD_GROUP := saned
else

ifeq ($(OSTYPE),OpenBSD)
SCANBD_GROUP := lp
endif # OpenBSD

ifeq ($(OSTYPE),FreeBSD)
SCANBD_GROUP := lp
endif

ifeq ($(OSTYPE),NetBSD)
SCANBD_GROUP := lp
endif

ifeq ($(OSTYPE),Linux)
ifeq ($(shell grep scanner: /etc/passwd), "scanner:")
SCANBD_GROUP := scanner
else
SCANBD_GROUP := lp
endif
endif

endif	# USE_LIBUDEV

endif	# SCANBD_GROUP

